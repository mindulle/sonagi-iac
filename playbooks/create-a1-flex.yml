---
- name: Try to create OCI A1.Flex instance
  hosts: localhost
  gather_facts: yes
  vars:
    compartment_id: "ocid1.compartment.oc1..aaaaaaaaawzq3u3bdxcpfl7akunojtmfmn72ygy4j5wk2tgyvhmg6gtkhjya"
    availability_domain: "AOBe:AP-CHUNCHEON-1-AD-1"
    subnet_id: "ocid1.subnet.oc1.ap-chuncheon-1.aaaaaaaataxj57tretsr7h7wk7tbh4a6bjhqy67wzdxdil4blez4rh4yvxzq"
    image_id: "ocid1.image.oc1.ap-chuncheon-1.aaaaaaaatm4c52kym27acnlrbzqvysys2gwwip7ukz5ax6yxzyqhys3oal5a"
    shape: "VM.Standard.A1.Flex"
    ocpus: 4
    memory_in_gbs: 24
    oci_config_file: "/home/ubuntu/.oci/config"
    oci_config_profile: "tokyo"
    discord_webhook: "{{ lookup('env', 'DISCORD_WEBHOOK_URL') }}"

  tasks:
    - name: Generate timestamp for instance name
      set_fact:
        timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
        instance_name: "a1-flex-auto-{{ ansible_date_time.epoch }}"

    - name: Try to create A1.Flex instance
      shell: |
        oci --profile {{ oci_config_profile }} compute instance launch \
          --config-file {{ oci_config_file }} \
          --compartment-id {{ compartment_id }} \
          --availability-domain "{{ current_ad }}" \
          --shape {{ shape }} \
          --shape-config '{"ocpus":{{ ocpus }},"memoryInGBs":{{ memory_in_gbs }}}' \
          --subnet-id {{ subnet_id }} \
          --image-id {{ image_id }} \
          --display-name "{{ instance_name }}" \
          --assign-public-ip true \
          --wait-for-state RUNNING \
          --max-wait-seconds 300
      register: instance_result
      ignore_errors: yes
      changed_when: instance_result.rc == 0

    - name: Parse instance info on success
      set_fact:
        instance_info: "{{ instance_result.stdout | from_json }}"
      when: instance_result.rc == 0

    - name: Display result
      debug:
        msg: |
          {% if instance_result.rc == 0 %}
          ‚úÖ SUCCESS: A1.Flex instance created!
          Instance ID: {{ instance_info.data.id }}
          Display Name: {{ instance_info.data['display-name'] }}
          Shape: {{ instance_info.data.shape }}
          State: {{ instance_info.data['lifecycle-state'] }}
          {% else %}
          ‚ùå FAILED: {{ instance_result.stderr | default('No capacity available') }}
          {% endif %}

    - name: Send Discord notification on success
      uri:
        url: "{{ discord_webhook }}"
        method: POST
        body_format: json
        body:
          content: "@everyone üéâ **A1.Flex Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ± ÏÑ±Í≥µ!**"
          embeds:
            - title: "ÎìúÎîîÏñ¥ ÏÑ±Í≥µ!"
              description: "A1.Flex Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!"
              color: 5763719
              fields:
                - name: "Instance ID"
                  value: "{{ instance_info.data.id }}"
                - name: "Display Name"
                  value: "{{ instance_info.data['display-name'] }}"
                - name: "Shape"
                  value: "{{ shape }} ({{ ocpus }} OCPU, {{ memory_in_gbs }}GB RAM)"
                - name: "Region"
                  value: "ap-chuncheon-1"
                - name: "Created At"
                  value: "{{ timestamp }}"
              timestamp: "{{ ansible_date_time.iso8601 }}"
        status_code: [200, 204]
      when:
        - instance_result.rc == 0
        - discord_webhook != ""
      ignore_errors: yes

    - name: Fail task if creation failed (for retry logic)
      fail:
        msg: "Instance creation failed. Will retry in next run."
      when: instance_result.rc != 0
